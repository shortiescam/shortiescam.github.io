<!DOCTYPE html>
<!-- 
    This script handles loading the dark/light theme instantly to prevent flashing.
    It checks localStorage first, then falls back to the user's system preference.
-->
<script>
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
</script>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 
        Viewport settings for a non-resizable, full-screen mobile-first experience.
        'viewport-fit=cover' ensures the app fills the entire screen on devices with notches (like iPhones).
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Shorties - 6 Second Video</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/93dkgst4/video-video-call-camera-record-svgrepo-com.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Base styles */
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            /* Prevent overscroll bounce on iOS */
            overscroll-behavior-y: none;
            /* Prevent text selection when holding buttons */
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            -moz-user-select: none;
            /* Default light mode colors */
            background-color: #ffffff; /* bg-white */
            color: #111827; /* text-gray-900 */
            transition: background-color 0.2s linear, color 0.2s linear;
        }
        
        /* --- Dark Mode Styles --- */
        html.dark body {
            background-color: #111827; /* bg-gray-900 */
            color: #f3f4f6; /* text-gray-100 */
        }
        html.dark #loading-view {
            background-color: #111827; /* bg-gray-900 */
        }
        html.dark #loading-view p,
        html.dark #permissions-view p,
        html.dark #recording-view p.text-gray-600,
        html.dark #library-view p {
            color: #9ca3af; /* text-gray-400 */
        }
        html.dark .bg-gray-200 {
            background-color: #374151; /* bg-gray-700 */
            color: #f9fafb; /* text-gray-50 */
        }
        html.dark .bg-gray-200:hover {
            background-color: #4b5563; /* bg-gray-600 */
        }
        html.dark .bg-gray-800 {
            background-color: #030712; /* bg-gray-950 */
        }
        /* Modal dark styles */
        html.dark #download-modal .modal-content,
        html.dark #confirm-modal .modal-content,
        html.dark #library-modal-content {
            background-color: #1f2937; /* bg-gray-800 */
        }
        html.dark .modal-content .text-gray-900 {
            color: #f9fafb; /* text-gray-50 */
        }
        html.dark .modal-content .text-gray-600 {
            color: #9ca3af; /* text-gray-400 */
        }
        html.dark .modal-content .bg-gray-200 {
            background-color: #4b5563; /* bg-gray-600 */
        }
        html.dark .modal-content .bg-gray-200:hover {
            background-color: #525c6a;
        }
        html.dark .library-item {
            background-color: #374151; /* bg-gray-700 */
        }
        html.dark .modal-actions-container {
             background-color: #111827; /* bg-gray-900 */
        }

        /* Force 1:1 aspect ratio for video containers */
        .aspect-square {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* 1:1 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 1.5rem; /* rounded-3xl */
        }

        .aspect-square > video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Fill the square, cropping as needed */
            cursor: pointer; /* Add pointer cursor to indicate it's clickable */
            /* FIX: Prevents the grey background flash on mobile before video loads. */
            background-color: #000;
        }
        
        /* Circular progress bar */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            stroke: #3b82f6; /* default blue-500 */
        }
        html.dark .progress-ring__circle_bg {
            color: #374151; /* bg-gray-700 */
        }
        
        /* --- Record Button Animations --- */
        @keyframes pulse-record {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); /* red-500 */
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        .is-recording {
            animation: pulse-record 1.5s infinite;
        }
        
        @keyframes riffle-paused {
            0% {
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.4);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0);
            }
        }
        .is-paused {
            animation: riffle-paused 2s infinite ease-out;
        }
        
        /* Toast notification */
        #toast {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100%);
            opacity: 0;
            z-index: 100;
            /* Adjust for safe area */
            margin-bottom: env(safe-area-inset-bottom, 1rem);
        }
        
        #toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Hide scrollbars for the main container */
        #app-container::-webkit-scrollbar {
            display: none;
        }

        /* MOBILE SAFE AREA: Add padding for scrolling content */
        #app-container {
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }
        
        /* MOBILE SAFE AREA: Add padding to the bottom of fixed-view controls to avoid system nav bars */
        #recording-controls, #preview-actions {
            padding-bottom: env(safe-area-inset-bottom, 1rem);
        }

        /* Loading Spinner */
        #loading-view {
            z-index: 200;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        html.dark .loader {
             border: 4px solid #374151; /* Dark grey */
             border-top: 4px solid #3b82f6; /* Blue */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- Improved Custom Video Controls --- */
        .video-player-container {
            position: relative;
            background: #000; /* Black background for 1:1 player */
            border-radius: 1.5rem; /* rounded-3xl */
        }
        
        .custom-controls-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0));
            padding: 12px;
            padding-top: 24px; /* More space on top */
            border-bottom-left-radius: 1.5rem; /* match video */
            border-bottom-right-radius: 1.5rem; /* match video */
            z-index: 22;
        }
        
        .play-pause-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 50%;
            width: 44px; /* Slightly larger */
            height: 44px; /* Slightly larger */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s ease;
        }
        .play-pause-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .play-pause-btn:active {
            transform: scale(0.95);
        }
        
        /* Custom progress bar */
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden; /* Ensure progress bar stays within bounds */
            margin-bottom: 8px; /* Space between bar and buttons */
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: #3b82f6; /* blue-500 */
            border-radius: 4px;
            transition: width 0.1s linear; /* Smooth progress */
        }
        
        /* Big center play button */
        .big-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 21;
            transition: opacity 0.3s ease, transform 0.2s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .big-play-button:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* Show when paused */
        .video-player-container.paused .big-play-button {
            opacity: 1;
            visibility: visible;
        }

        .big-play-button i.fa-play {
            font-size: 40px;
            color: white;
            margin-left: 3px; /* Nudge icon for better visual centering */
        }
        
        /* Center play icon in smaller button */
        .play-pause-btn i.fa-play {
            margin-left: 1px; /* Nudge icon for better visual centering */
        }

        /* --- Modal Styles --- */
        .modal-backdrop {
            z-index: 150;
            transition: opacity 0.2s ease-in-out;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .modal-backdrop.hidden {
            opacity: 0;
        }
        
        /* Library Modal (1:1 Aspect Ratio) */
        #library-modal-content {
            width: 100%;
            max-width: 500px; /* Max width */
            padding-bottom: 100%; /* 1:1 padding hack */
            position: relative;
        }
        
        #library-modal-body {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
        }
        
        #library-modal-player-container {
            width: 100%;
            height: 100%; /* Fill the 1:1 space */
        }

        #library-modal-player-container video {
             border-radius: 0; /* No radius inside modal */
             background-color: #000;
             width: 100%;
             height: 100%;
             object-fit: cover; /* Make the video fill the container */
        }
        
        /* Library Grid */
        #library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.50rem;
        }
        
        .library-item {
            position: relative;
            aspect-ratio: 1 / 1;
            background: #e5e7eb; /* bg-gray-200 */
            border-radius: 0.75rem; /* rounded-lg */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0.5rem;
            cursor: pointer;
            overflow: hidden;
            text-align: center;
            transition: transform 0.2s ease;
        }
        .library-item:active {
            transform: scale(0.95);
        }
        
        .library-item-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .library-item-icon {
            font-size: 2.5rem; /* text-4xl */
            color: #6b7280; /* text-gray-500 */
        }
        html.dark .library-item-icon {
             color: #d1d5db; /* text-gray-300 */
        }

        .library-item-date {
            font-size: 0.75rem; /* text-xs */
            color: #fff;
            position: absolute;
            bottom: 8px;
            background: rgba(0,0,0,0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }
        html.dark .library-item-date {
            color: #f9fafb;
        }
        
        .library-item-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.4);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 10;
            transition: background-color 0.2s, transform 0.2s;
        }
        .library-item-delete:hover {
            background: rgba(239, 68, 68, 0.8); /* red-500 */
            transform: scale(1.1);
        }
        
        /* New layout for controls */
        #action-buttons-container {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Spread them out */
            width: 100%;
            margin-top: 1rem;
        }
        
        /* Generic button improvements */
        .btn {
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s ease;
            transform-origin: center;
        }
        .btn:active {
            transform: scale(0.95);
        }
        
        /* Glowing shadow for primary button */
        #get-camera-button:hover {
            box-shadow: 0 5px 15px -3px rgba(59, 130, 246, 0.4);
        }
        
        /* Gradient text for header */
        .header-title {
            background: -webkit-linear-gradient(45deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        html.dark .header-title {
            background: -webkit-linear-gradient(45deg, #60a5fa, #93c5fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

    </style>
</head>

<body class="overflow-hidden h-screen">

    <!-- Loading View -->
    <div id="loading-view" class="fixed inset-0 bg-white flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600">Initializing App...</p>
    </div>

    <!-- Main App Container -->
    <div class="flex flex-col h-screen max-w-md mx-auto">
        
        <!-- Header -->
        <header class="flex items-center justify-between p-4 w-full relative">
            <button id="library-button" class="btn w-10 h-10 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">
                <i class="fas fa-folder-open text-xl"></i>
            </button>
            
            <h1 class="header-title text-3xl font-extrabold text-blue-500 absolute left-1/2 -translate-x-1/2">Shorties</h1>
            
            <button id="theme-toggle-button" class="btn w-10 h-10 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">
                <i id="theme-icon" class="fa-solid fa-sun text-xl"></i>
            </button>
        </header>

        <!-- Main Content Area -->
        <main id="app-container" class="flex-1 flex flex-col p-4 overflow-y-auto">
            
            <!-- Permissions View -->
            <div id="permissions-view" class="hidden flex-1 flex flex-col items-center justify-center text-center">
                <div class="p-5 bg-blue-100 dark:bg-blue-900/50 rounded-full mb-6 flex items-center justify-center" style="width: 80px; height: 80px;">
                    <i class="fas fa-video fa-2x text-blue-500 dark:text-blue-400"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Ready to create a Shortie?</h2>
                <p class="text-gray-600 mb-8">We'll need access to your camera and microphone to record.</p>
                <button id="get-camera-button" class="btn w-full bg-blue-500 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg hover:bg-blue-600 transition-all flex items-center justify-center">
                    <i class="fas fa-camera mr-2"></i>
                    Enable Camera & Mic
                </button>
            </div>
            
            <!-- Recording View -->
            <div id="recording-view" class="hidden flex-1 flex flex-col justify-between">
                <!-- Video Preview -->
                <div class="aspect-square bg-gray-800 rounded-3xl shadow-lg w-full mx-auto">
                    <video id="preview" muted autoplay playsinline class="rounded-3xl"></video>
                </div>
                
                <!-- Recording Controls -->
                <div id="recording-controls" class="flex flex-col items-center gap-4 mt-6">
                    <!-- Progress Ring & Timer -->
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <!-- Background ring -->
                            <circle class="text-gray-200 progress-ring__circle_bg" stroke-width="8" stroke="currentColor" fill="transparent" r="46" cx="50" cy="50" />
                            
                            <!-- Completed segments container -->
                            <g id="progress-segments-container"></g>
                            
                            <!-- Active recording segment (animated) -->
                            <circle id="active-progress-segment" class="progress-ring__circle" stroke-width="8" fill="transparent" r="46" cx="50" cy="50" stroke-dasharray="0 289" />
                        </svg>
                        <!-- Timer Text -->
                        <div id="timer-text" class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-2xl font-semibold">
                            0.0s
                        </div>
                    </div>
                    
                    <p id="record-instructions" class="text-gray-600 text-sm">Hold to record, release to pause</p>

                    <!-- Main Record Buttons -->
                    <div class="flex items-center justify-center w-full mt-2 gap-4">
                        <button id="mode-hold" class="btn w-16 h-16 bg-gray-200 rounded-full shadow-lg flex items-center justify-center text-xl text-blue-500 ring-2 ring-blue-500" title="Hold to Record">
                            <i class="fas fa-hand-pointer"></i>
                        </button>
                        
                        <button id="record-button" class="w-20 h-20 bg-red-500 rounded-full shadow-xl focus:outline-none transition-all duration-200 active:scale-95 flex items-center justify-center disabled:opacity-50">
                            <i id="record-button-icon" class="fas fa-video text-white text-3xl transition-transform"></i>
                        </button>
            
                        <button id="mode-lock" class="btn w-16 h-16 bg-gray-200 rounded-full shadow-lg flex items-center justify-center text-xl text-gray-500 dark:text-gray-400" title="Tap to Lock Record">
                            <i class="fas fa-lock"></i>
                        </button>
                    </div>

                    <!-- Action Buttons (Flip, Restart, Next) -->
                    <div id="action-buttons-container">
                        <!-- Left-side utility buttons -->
                        <div class="flex items-center gap-4">
                            <button id="flip-camera-button" class="btn w-16 h-16 bg-gray-200 rounded-full shadow-lg hover:bg-gray-300 flex items-center justify-center text-xl disabled:opacity-50 hidden" title="Flip Camera">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            
                            <!-- NEW RESTART BUTTON -->
                            <button id="restart-button" class="btn w-16 h-16 bg-gray-200 rounded-full shadow-lg hover:bg-gray-300 flex items-center justify-center text-xl text-red-500 disabled:opacity-50 hidden" title="Start Over">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        
                        <!-- Right-side next button -->
                        <button id="next-button" class="btn bg-gray-200 font-medium py-3 px-6 rounded-xl shadow-lg hover:bg-gray-300 flex items-center justify-center text-lg disabled:opacity-50 disabled:cursor-not-allowed flex-grow-0" disabled>
                            Next
                            <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Preview View -->
            <div id="preview-view" class="hidden flex-1 flex flex-col justify-between">
                <!-- Video Player -->
                <div id="video-container" class="video-player-container aspect-square bg-gray-900 rounded-3xl shadow-lg w-full mx-auto paused">
                    <video id="recorded-video" loop playsinline class="rounded-3xl"></video>
                    
                    <div id="preview-big-play-button" class="big-play-button">
                        <i class="fas fa-play"></i>
                    </div>
                    
                    <div id="preview-custom-controls" class="custom-controls-container flex flex-col">
                        <div id="preview-progress-bar-container" class="progress-bar-container">
                            <div id="preview-progress-bar" class="progress-bar"></div>
                        </div>
                        <div class="flex items-center justify-between">
                            <button id="preview-play-pause-btn" class="play-pause-btn">
                                <i id="preview-play-pause-icon" class="fas fa-play"></i>
                            </button>
                            <button id="preview-mute-btn" class="play-pause-btn">
                                <i id="preview-mute-icon" class="fas fa-volume-high"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Preview Actions -->
                <div id="preview-actions" class="flex flex-col gap-3 mt-6">
                    <h3 class="text-xl font-semibold text-center mb-2">Your Shortie is ready!</h3>
                    
                    <button id="download-video-button" class="btn w-full text-center bg-blue-500 text-white font-bold py-3 px-6 rounded-xl text-lg shadow-lg hover:bg-blue-600 flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i>
                        Save to Device
                    </button>
                    
                    <button id="record-another-button" class="btn w-full bg-gray-200 font-medium py-3 px-6 rounded-xl shadow-lg hover:bg-gray-300 flex items-center justify-center">
                        <i class="fas fa-redo mr-2"></i>
                        Record Another
                    </button>
                </div>
            </div>
            
            <!-- Library View -->
            <div id="library-view" class="hidden flex-1 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                     <h2 class="text-2xl font-bold">My Library</h2>
                     <button id="library-back-button" class="btn w-10 h-10 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <p class="text-gray-600 mb-6">Videos you save are stored here, on this device.</p>
                
                <div id="library-grid" class="flex-0 overflow-y-auto">
                    <!-- Library items will be injected here -->
                </div>
                
                <div id="library-empty-state" class="hidden flex-1 flex-col items-center justify-center text-center p-8">
                    <i class="fas fa-folder-open text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-xl font-semibold">Library is Empty</h3>
                    <p class="text-gray-600 mt-2">Record a video and tap "Save to Device" to add it to your library.</p>

                </div>
            </div>
            
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 left-4 right-4 max-w-md mx-auto bg-red-500 text-white p-4 rounded-lg shadow-lg">
        <p id="toast-message">Error message goes here</p>
    </div>
    
    <!-- Download Modal -->
    <div id="download-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl p-6 shadow-xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-green-100 dark:bg-green-900/50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check fa-2x text-green-500 dark:text-green-400"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">Saved!</h2>
            <p class="text-gray-600 mb-6">Your video is saved to your device and added to your library.</p>
            <div class="flex flex-col gap-3">
                <button id="modal-close-button" class="btn w-full bg-gray-200 font-medium py-3 px-5 rounded-xl shadow-lg hover:bg-gray-300 flex items-center justify-center">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- NEW Confirmation Modal (for Restart) -->
    <div id="confirm-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-2xl p-6 shadow-xl w-full max-w-sm text-center">
            <div class="w-16 h-16 bg-red-100 dark:bg-red-900/50 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle fa-2x text-red-500 dark:text-red-400"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">Are you sure?</h2>
            <p class="text-gray-600 mb-6">This will delete your current recording. This action cannot be undone.</p>
            <div class="flex gap-3">
                <button id="confirm-cancel" class="btn w-full bg-gray-200 font-medium py-3 px-5 rounded-xl shadow-lg hover:bg-gray-300 flex items-center justify-center">
                    Cancel
                </button>
                <button id="confirm-ok" class="btn w-full bg-red-500 text-white font-bold py-3 px-5 rounded-xl shadow-lg hover:bg-red-600 flex items-center justify-center">
                    Restart
                </button>
            </div>
        </div>
    </div>
    
    <!-- Library Player Modal -->
    <div id="library-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="flex flex-col w-full max-w-md bg-transparent rounded-3xl overflow-hidden">
            
            <div id="library-modal-content" class="bg-black shadow-xl w-full rounded-t-3xl">
                <div id="library-modal-body">
                    
                    <button id="library-modal-close" class="btn absolute top-3 right-3 w-10 h-10 bg-black bg-opacity-50 rounded-full text-white flex items-center justify-center z-50">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    
                    <div id="library-modal-player-container" class="video-player-container w-full h-full rounded-none paused">
                        <video id="library-video-player" loop playsinline></video>
                        
                        <div id="library-big-play-button" class="big-play-button">
                            <i class="fas fa-play"></i>
                        </div>
                        
                        <div id="library-custom-controls" class="custom-controls-container flex flex-col rounded-none">
                            <div id="library-progress-bar-container" class="progress-bar-container">
                                <div id="library-progress-bar" class="progress-bar"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <button id="library-play-pause-btn" class="play-pause-btn">
                                    <i id="library-play-pause-icon" class="fas fa-play"></i>
                                </button>
                                <button id="library-mute-btn" class="play-pause-btn">
                                    <i id="library-mute-icon" class="fas fa-volume-high"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions-container bg-black p-4 rounded-b-3xl">
                <div class="flex items-center justify-center gap-4">
                    <button id="library-modal-download" class="btn w-full bg-blue-500 text-white font-bold py-3 px-5 rounded-xl text-lg shadow-lg hover:bg-blue-600 flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i> Download
                    </button>
                </div>
            </div>

        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const loadingView = document.getElementById('loading-view');
            const views = {
                permissions: document.getElementById('permissions-view'),
                recording: document.getElementById('recording-view'),
                preview: document.getElementById('preview-view'),
                library: document.getElementById('library-view'),
            };
            
            // Header
            const libraryButton = document.getElementById('library-button');
            const themeToggleButton = document.getElementById('theme-toggle-button');
            const themeIcon = document.getElementById('theme-icon');
            
            // Permissions
            const getCameraButton = document.getElementById('get-camera-button');
            
            // Recording
            const previewVideo = document.getElementById('preview');
            const recordButton = document.getElementById('record-button');
            const recordButtonIcon = document.getElementById('record-button-icon');
            const recordInstructions = document.getElementById('record-instructions');
            const modeHoldButton = document.getElementById('mode-hold');
            const modeLockButton = document.getElementById('mode-lock');
            
            const nextButton = document.getElementById('next-button');
            const flipCameraButton = document.getElementById('flip-camera-button');
            const restartButton = document.getElementById('restart-button'); // NEW
            const timerText = document.getElementById('timer-text');
            
            // Progress Ring Elements
            const progressSegmentsContainer = document.getElementById('progress-segments-container');
            const activeProgressSegment = document.getElementById('active-progress-segment'); 
            
            // Preview Screen Elements
            const videoContainer = document.getElementById('video-container');
            const recordedVideo = document.getElementById('recorded-video');
            const previewBigPlayButton = document.getElementById('preview-big-play-button');
            const previewPlayPauseBtn = document.getElementById('preview-play-pause-btn');
            const previewPlayPauseIcon = document.getElementById('preview-play-pause-icon');
            const previewProgressBarContainer = document.getElementById('preview-progress-bar-container');
            const previewProgressBar = document.getElementById('preview-progress-bar');
            const previewMuteBtn = document.getElementById('preview-mute-btn'); 
            const previewMuteIcon = document.getElementById('preview-mute-icon');
            const downloadVideoButton = document.getElementById('download-video-button');
            const recordAnotherButton = document.getElementById('record-another-button');
            
            // Library Screen
            const libraryGrid = document.getElementById('library-grid');
            const libraryEmptyState = document.getElementById('library-empty-state');
            const libraryBackButton = document.getElementById('library-back-button');
            
            // Library Modal
            const libraryModal = document.getElementById('library-modal');
            const libraryModalClose = document.getElementById('library-modal-close');
            const libraryPlayerContainer = document.getElementById('library-modal-player-container');
            const libraryVideoPlayer = document.getElementById('library-video-player');
            const libraryBigPlayButton = document.getElementById('library-big-play-button');
            const libraryPlayPauseBtn = document.getElementById('library-play-pause-btn');
            const libraryPlayPauseIcon = document.getElementById('library-play-pause-icon');
            const libraryProgressBarContainer = document.getElementById('library-progress-bar-container');
            const libraryProgressBar = document.getElementById('library-progress-bar');
            const libraryMuteBtn = document.getElementById('library-mute-btn');
            const libraryMuteIcon = document.getElementById('library-mute-icon');
            const libraryModalDownload = document.getElementById('library-modal-download');
            
            // Download Modal
            const downloadModal = document.getElementById('download-modal');
            const modalCloseButton = document.getElementById('modal-close-button');

            // Confirm Modal (NEW)
            const confirmModal = document.getElementById('confirm-modal');
            const confirmCancel = document.getElementById('confirm-cancel');
            const confirmOk = document.getElementById('confirm-ok');
            
            // Toast
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            // --- State Variables ---
            let mediaRecorder;
            let stream;
            let recordedChunks = []; // Array to hold ALL chunks
            let recordedBlob;
            let totalRecordedTime = 0; // in milliseconds
            let chunkStartTime = 0;
            let recordingInterval;
            const MAX_DURATION = 6000; // 6 seconds
            let facingMode = 'user'; // 'user' (front) or 'environment' (back)
            let currentView = '';
            let db; // IndexedDB instance
            let libraryModalBlob = null;
            let recordingMode = 'hold';
            let isRecording = false;
            let segmentDurations = []; // Store durations of each segment

            // --- Constants ---
            const circumference = 2 * Math.PI * 46; // 2 * pi * r
            const blueShades = ["#1d4ed8", "#2563eb", "#3b82f6", "#60a5fa", "#93c5fd"]; // Colors for segments
            
            // Set initial dash array for the full ring (empty)
            activeProgressSegment.setAttribute('stroke-dasharray', `${circumference} ${circumference}`);
            activeProgressSegment.setAttribute('stroke-dashoffset', circumference); 
            
            const DB_NAME = 'ShortiesDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'videos';

            // --- Initialization ---
            async function init() {
                updateThemeIcon();
                
                setupEventListeners();

                try {
                    await initDB();
                    await checkPermissionsAndStart();
                } catch (err) {
                    console.error("Initialization failed:", err);
                    showToast("Could not load library storage.");
                    showView('permissions');
                } finally {
                    loadingView.classList.add('hidden');
                }
            }

            function setupEventListeners() {
                libraryButton.addEventListener('click', () => showView('library'));
                themeToggleButton.addEventListener('click', toggleTheme);
                getCameraButton.addEventListener('click', requestCameraAndStart);
                flipCameraButton.addEventListener('click', flipCamera);
                restartButton.addEventListener('click', showConfirmResetModal); // NEW

                modeHoldButton.addEventListener('click', () => setRecordingMode('hold'));
                modeLockButton.addEventListener('click', () => setRecordingMode('lock'));
                recordButton.addEventListener('pointerdown', handleRecordPointerDown);
                recordButton.addEventListener('pointerup', handleRecordPointerUp);
                recordButton.addEventListener('pointerleave', handleRecordPointerUp);
                recordButton.addEventListener('click', handleRecordClick);
                
                nextButton.addEventListener('click', finishRecording);
                downloadVideoButton.addEventListener('click', downloadAndSaveToLibrary);
                recordAnotherButton.addEventListener('click', () => {
                    showView('recording');
                    startCamera(false); // Pass false to trigger reset
                });
                libraryBackButton.addEventListener('click', () => {
                    checkPermissionsAndStart();
                });
                modalCloseButton.addEventListener('click', () => downloadModal.classList.add('hidden'));
                
                // NEW Confirm Modal Listeners
                confirmCancel.addEventListener('click', () => confirmModal.classList.add('hidden'));
                confirmOk.addEventListener('click', () => {
                    confirmModal.classList.add('hidden');
                    resetRecordingProgress();
                });

                libraryModalClose.addEventListener('click', closeLibraryPlayer);
                libraryModalDownload.addEventListener('click', () => downloadVideo(libraryModalBlob));

                setupVideoPlayer(videoContainer, recordedVideo, previewBigPlayButton, previewPlayPauseBtn, previewPlayPauseIcon, previewProgressBarContainer, previewProgressBar, previewMuteBtn, previewMuteIcon);
                setupVideoPlayer(libraryPlayerContainer, libraryVideoPlayer, libraryBigPlayButton, libraryPlayPauseBtn, libraryPlayPauseIcon, libraryProgressBarContainer, libraryProgressBar, libraryMuteBtn, libraryMuteIcon);
            }
            
            // --- Permissions ---
			async function checkPermissionsAndStart() {
				if (navigator.permissions) {
					try {
						const cameraStatus = await navigator.permissions.query({ name: 'camera' });
						const micStatus = await navigator.permissions.query({ name: 'microphone' });

						if (cameraStatus.state === 'granted' && micStatus.state === 'granted') {
							await startCamera();
						} else {
							showView('permissions');
						}
                    } catch (error) {
                        console.error("Permissions API not supported or error:", error);
                        showView('permissions');
                    }
                } else {
                    showView('permissions');
                }
            }
            
            async function requestCameraAndStart() {
                try {
                    await startCamera();
                } catch (err) {
                    console.error('Error getting media:', err);
                    if (err.name === 'NotAllowedError') {
                        showToast('Camera and Mic access was denied.');
                    } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
                        showToast('Could not find a suitable camera.');
                    } else {
                        showToast('Error starting camera. Please refresh.');
                    }
                    showView('permissions');
                }
            }

            // --- View Management ---
            function showView(viewId) {
                if (currentView === 'preview') recordedVideo.pause();
                if (currentView === 'library') closeLibraryPlayer();
                
                Object.values(views).forEach(view => view.classList.add('hidden'));
                
                if (views[viewId]) {
                    views[viewId].classList.remove('hidden');
                    views[viewId].classList.add('flex');
                    currentView = viewId;
                    
                    if (viewId === 'library') loadLibrary();
                    if (viewId === 'preview') recordedVideo.play().catch(e => console.error("Autoplay failed:", e));
                }
            }
            
            // --- Toast Notifications ---
            function showToast(message, duration = 3000) {
                toastMessage.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            }

            // --- Theme Toggling ---
            function toggleTheme() {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                updateThemeIcon();
            }

            function updateThemeIcon() {
                // Use fa-sun for light mode, fa-moon for dark mode
                themeIcon.classList.toggle('fa-sun', !document.documentElement.classList.contains('dark'));
                themeIcon.classList.toggle('fa-moon', document.documentElement.classList.contains('dark'));
            }

            // --- Core Functionality ---
            function stopCurrentStream() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
            }
            
            async function updateFlipCameraButtonVisibility() {
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    try {
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        const videoInputDevices = devices.filter(device => device.kind === 'videoinput');
                        flipCameraButton.classList.toggle('hidden', videoInputDevices.length <= 1);
                    } catch (err) {
                        console.error('Could not enumerate devices:', err);
                        flipCameraButton.classList.add('hidden');
                    }
                } else {
                    flipCameraButton.classList.add('hidden');
                }
            }

            async function startCamera(preserveProgress = false) {
                stopCurrentStream();
                
                const constraints = {
                    audio: true,
                    video: { facingMode: facingMode }
                };

                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    previewVideo.srcObject = stream;
                    previewVideo.style.transform = (facingMode === 'user') ? 'scaleX(-1)' : 'scaleX(1)';
                    
                    await updateFlipCameraButtonVisibility();

                    if (!preserveProgress) {
                        resetRecordingProgress();
                    }
                    initializeMediaRecorder();
                    showView('recording');
                } catch (err) {
                     throw err;
                }
            }
            
			async function flipCamera() {
				if (isRecording) {
                    pauseRecording();
				}

                if (mediaRecorder) {
                    mediaRecorder.onstop = null;
                }

                flipCameraButton.disabled = true;
                restartButton.disabled = true; // NEW
                recordButton.disabled = true;

				facingMode = (facingMode === 'user') ? 'environment' : 'user';
                
				try {
					await startCamera(false); // Flipping camera always resets progress
				} catch (err) {
					showToast("Could not switch camera.");
					facingMode = (facingMode === 'user') ? 'environment' : 'user';
				} finally {
                    flipCameraButton.disabled = false;
                    restartButton.disabled = false; // NEW
                    recordButton.disabled = false;
                }
			}

            // NEW: Modal for reset confirmation
            function showConfirmResetModal() {
                if (totalRecordedTime > 0) {
                    confirmModal.classList.remove('hidden');
                }
            }

            function resetRecordingProgress() {
                clearInterval(recordingInterval);

                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.onstop = null; 
                    mediaRecorder.ondataavailable = null;
                    mediaRecorder.onerror = null;
                    mediaRecorder.stop(); 
                }

                recordedChunks = []; // Clear all chunks
                recordedBlob = null; 
                totalRecordedTime = 0;
                segmentDurations = []; // Clear segments
                isRecording = false;
                
                // Update UI to its initial state
                updateTimerText(0);
                
                // Reset progress ring visual
                progressSegmentsContainer.innerHTML = ''; // Clear completed segments
                activeProgressSegment.style.strokeDashoffset = circumference;
                
                nextButton.disabled = true;
                
                // NEW: Hide and disable restart button
                restartButton.classList.add('hidden');
                restartButton.disabled = true;

                recordButton.classList.remove('is-recording', 'is-paused');
                recordButtonIcon.classList.remove('fa-stop');
                recordButtonIcon.classList.add('fa-video');
                
                if (flipCameraButton && !flipCameraButton.classList.contains('hidden')) {
                    flipCameraButton.disabled = false;
                }
                
                console.log("Recording progress has been reset.");
            }

            function initializeMediaRecorder() {
                if (!stream) return;

                const options = [
                    'video/mp4; codecs=avc1,mp4a.40.2',
                    'video/webm; codecs=vp9,opus',
                    'video/webm; codecs=vp8,opus',
                    'video/webm'
                ].find(type => MediaRecorder.isTypeSupported(type));

                try {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: options });
                
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        if (recordedChunks.length === 0) {
                            console.log("No chunks to create blob from.");
                            resetRecordingProgress();
                            // Re-initialize recorder to allow recording again
                            initializeMediaRecorder();
                            return;
                        };

                        const mimeType = recordedChunks[0].type || mediaRecorder.mimeType || 'video/mp4';
                        recordedBlob = new Blob(recordedChunks, { type: mimeType });
                        recordedVideo.src = URL.createObjectURL(recordedBlob);
                        recordedVideo.muted = false;
                        showView('preview');
                    };
                    
                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        showToast('An error occurred during recording.');
                    };
                } catch (err) {
                    console.error('Failed to create MediaRecorder:', err);
                    showToast('This device may not be supported for recording.');
                    mediaRecorder = null;
                    showView('permissions');
                }
            }

            // --- Recording Mode Logic ---
            function setRecordingMode(mode) {
                if (isRecording) return;
                recordingMode = mode;
                
                const isHoldMode = mode === 'hold';
                modeHoldButton.classList.toggle('text-blue-500', isHoldMode);
                modeHoldButton.classList.toggle('ring-2', isHoldMode);
                modeHoldButton.classList.toggle('ring-blue-500', isHoldMode);
                modeHoldButton.classList.toggle('text-gray-500', !isHoldMode);
                modeHoldButton.classList.toggle('dark:text-gray-400', !isHoldMode);

                modeLockButton.classList.toggle('text-blue-500', !isHoldMode);
                modeLockButton.classList.toggle('ring-2', !isHoldMode);
                modeLockButton.classList.toggle('ring-blue-500', !isHoldMode);
                modeLockButton.classList.toggle('text-gray-500', isHoldMode);
                modeLockButton.classList.toggle('dark:text-gray-400', isHoldMode);
                
                recordInstructions.textContent = isHoldMode ? 'Hold to record, release to pause' : 'Tap to record, tap again to stop';
                recordButtonIcon.classList.remove('fa-stop');
                recordButtonIcon.classList.add('fa-video');
            }
            
            function handleRecordPointerDown() {
                if (recordingMode === 'hold') startRecording();
            }
            
            function handleRecordPointerUp() {
                if (recordingMode === 'hold') pauseRecording();
            }
            
            function handleRecordClick() {
                if (recordingMode === 'lock') toggleLockRecording();
            }
            
            function toggleLockRecording() {
                if (isRecording) {
                    pauseRecording();
                    recordButtonIcon.classList.replace('fa-stop', 'fa-video');
                } else {
                    startRecording();
                    recordButtonIcon.classList.replace('fa-video', 'fa-stop');
                }
            }

            // --- Recording functions ---
            function startRecording() {
                if (!mediaRecorder || totalRecordedTime >= MAX_DURATION || isRecording) return;
                
                isRecording = true;
                if (flipCameraButton) {
                    flipCameraButton.disabled = true;
                }
                restartButton.disabled = true; // NEW
                
                if (mediaRecorder.state === 'inactive') mediaRecorder.start(100);
                else if (mediaRecorder.state === 'paused') mediaRecorder.resume();

                // Set color for the new active segment
                activeProgressSegment.style.stroke = blueShades[segmentDurations.length % blueShades.length];
                // Set the starting offset for the active segment
                activeProgressSegment.style.strokeDashoffset = circumference * (1 - totalRecordedTime / MAX_DURATION);
                activeProgressSegment.setAttribute('stroke-dasharray', circumference);

                recordButton.classList.remove('is-paused');
                recordButton.classList.add('is-recording');
                nextButton.disabled = true;
                
                chunkStartTime = Date.now();
                
                clearInterval(recordingInterval);
                recordingInterval = setInterval(updateProgress, 50);
            }

            function pauseRecording() {
                if (!mediaRecorder || mediaRecorder.state !== 'recording' || !isRecording) return;
                
                isRecording = false;
                mediaRecorder.pause();
                recordButton.classList.remove('is-recording');
                
                // Save chunk duration
                const chunkDuration = Date.now() - chunkStartTime;
                segmentDurations.push(chunkDuration);
                const oldTotalRecordedTime = totalRecordedTime;
                totalRecordedTime += chunkDuration; // Update total time
                
                clearInterval(recordingInterval);
                
                // Create a finalized circle for the segment just recorded
                const segmentCircle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                segmentCircle.setAttribute('class', 'progress-ring__circle');
                segmentCircle.setAttribute('stroke-width', '8');
                segmentCircle.setAttribute('fill', 'transparent');
                segmentCircle.setAttribute('r', '46');
                segmentCircle.setAttribute('cx', '50');
                segmentCircle.setAttribute('cy', '50');
                
                // Set its color
                segmentCircle.style.stroke = blueShades[(segmentDurations.length - 1) % blueShades.length];

                // Calculate its dash properties to show only this segment
                const segmentStartPercent = oldTotalRecordedTime / MAX_DURATION;
                const segmentPercent = chunkDuration / MAX_DURATION;
                
                const dash = segmentPercent * circumference;
                const gap = (1 - segmentPercent) * circumference;
                
                segmentCircle.setAttribute('stroke-dasharray', `${dash} ${gap}`);
                
                // The offset pushes the "dash" to the correct start position
                const offset = circumference * (1 - segmentStartPercent);
                segmentCircle.setAttribute('stroke-dashoffset', offset);

                progressSegmentsContainer.appendChild(segmentCircle);

                // Hide the active segment animator
                activeProgressSegment.style.strokeDashoffset = circumference;
                
                if (totalRecordedTime > 0) {
                    nextButton.disabled = false;
                    restartButton.disabled = false; // NEW
                    restartButton.classList.remove('hidden'); // NEW
                    recordButton.classList.add('is-paused');
                    if (flipCameraButton) {
                        flipCameraButton.disabled = true; // Keep disabled
                    }
                } else {
                    if (flipCameraButton && !flipCameraButton.classList.contains('hidden')) {
                        flipCameraButton.disabled = false;
                    }
                }
                
                updateTimerText(totalRecordedTime);
            }

            // Interval function to update progress
            function updateProgress() {
                const currentTimeInChunk = Date.now() - chunkStartTime;
                const currentTotalTime = totalRecordedTime + currentTimeInChunk;
                
                if (currentTotalTime >= MAX_DURATION) {
                    if (recordingMode === 'lock') toggleLockRecording();
                    else pauseRecording();
                    
                    finishRecording();
                } else {
                    // Update progress ring visual
                    const percent = currentTotalTime / MAX_DURATION;
                    const offset = circumference * (1 - percent);
                    activeProgressSegment.style.strokeDashoffset = offset;

                    // Update the timer text
                    updateTimerText(currentTotalTime);
                }
            }

            // Update timer text
            function updateTimerText(time) {
                const timeToDisplay = time !== undefined ? time : totalRecordedTime;
                const seconds = (timeToDisplay / 1000).toFixed(1);
                timerText.textContent = `${seconds}s`;
            }
            
            function finishRecording() {
                clearInterval(recordingInterval);
                isRecording = false;
                
                recordButton.classList.remove('is-recording', 'is-paused');
                nextButton.disabled = true;
                restartButton.disabled = true; // NEW
                restartButton.classList.add('hidden'); // NEW
                recordButtonIcon.classList.replace('fa-stop', 'fa-video');

                // Final check to stop the recorder if it's active
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                } else if (recordedChunks.length > 0) {
                    // Manually trigger the onstop if recorder is already inactive but we have chunks
                    mediaRecorder.onstop();
                } else {
                    showToast("Hold the record button to capture video first!");
                    // Re-enable buttons if no video was recorded
                    nextButton.disabled = (totalRecordedTime === 0);
                }
                stopCurrentStream();
            }
            
            // --- Video Player Logic ---
            function setupVideoPlayer(container, video, bigPlayBtn, playPauseBtn, playPauseIcon, progressContainer, progressBar, muteBtn, muteIcon) {
                const togglePlay = () => video.paused ? video.play() : video.pause();
                const toggleMute = () => video.muted = !video.muted;
                
                video.addEventListener('play', () => {
                    playPauseIcon.classList.replace('fa-play', 'fa-pause');
                    container.classList.remove('paused');
                });
                
                video.addEventListener('pause', () => {
                    playPauseIcon.classList.replace('fa-pause', 'fa-play');
                    container.classList.add('paused');
                });
                
                video.addEventListener('volumechange', () => {
                    muteIcon.classList.toggle('fa-volume-high', !video.muted);
                    muteIcon.classList.toggle('fa-volume-xmark', video.muted);
                });
                
                video.addEventListener('timeupdate', () => {
                    if (video.duration) {
                        progressBar.style.width = `${(video.currentTime / video.duration) * 100}%`;
                    }
                });
                
                progressContainer.addEventListener('click', (e) => {
                    if (video.duration) {
                        const rect = progressContainer.getBoundingClientRect();
                        video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration;
                    }
                });
                
                playPauseBtn.addEventListener('click', togglePlay);
                bigPlayBtn.addEventListener('click', togglePlay);
                muteBtn.addEventListener('click', toggleMute);
                video.addEventListener('click', togglePlay);
            }
            
            // --- Library (IndexedDB) Functions ---
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    request.onsuccess = e => { db = e.target.result; resolve(); };
                    request.onerror = e => reject(e.target.error);
                });
            }
            
            function generateThumbnail(blob) {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    const videoUrl = URL.createObjectURL(blob);
                    video.src = videoUrl;
                    video.muted = true;
                    video.onloadeddata = () => video.currentTime = 0.1;
                    video.onseeked = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                        URL.createObjectURL(videoUrl);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    video.onerror = (err) => {
                         URL.revokeObjectURL(videoUrl);
                         reject('Error generating thumbnail');
                    }
                });
            }
            
            async function saveVideoToLibrary(blob) {
                if (!db) return showToast("Library is not available.");
                try {
                    const thumbnail = await generateThumbnail(blob);
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    transaction.objectStore(STORE_NAME).add({
                        blob: blob,
                        date: new Date().toISOString(),
                        thumbnail: thumbnail
                    }).onsuccess = () => {
                        if (currentView === 'library') loadLibrary();
                    };
                } catch (error) {
                    showToast('Could not create video thumbnail.');
                }
            }
            
            function loadLibrary() {
                if (!db) return showToast("Library is not available.");
                const request = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).getAll();
                request.onsuccess = e => {
                    const videos = e.target.result.reverse();
                    libraryGrid.innerHTML = '';
                    const isEmpty = videos.length === 0;
                    libraryEmptyState.classList.toggle('hidden', !isEmpty);
                    libraryGrid.classList.toggle('hidden', isEmpty);
                    if (!isEmpty) {
                        videos.forEach(video => libraryGrid.appendChild(createLibraryItem(video)));
                    }
                };
            }
            
            function createLibraryItem(videoRecord) {
                const item = document.createElement('div');
                item.className = 'library-item';
                const dateString = new Date(videoRecord.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });

                item.innerHTML = `
                    <img src="${videoRecord.thumbnail}" class="library-item-thumbnail" alt="Video thumbnail">
                    <span class="library-item-date">${dateString}</span>
                    <button class="library-item-delete" data-id="${videoRecord.id}"><i class="fas fa-times"></i></button>
                `;
                
                item.addEventListener('click', e => {
                    if (!e.target.closest('.library-item-delete')) openLibraryPlayer(videoRecord.blob);
                });
                item.querySelector('.library-item-delete').addEventListener('click', () => deleteVideoFromLibrary(videoRecord.id));
                return item;
            }

            function deleteVideoFromLibrary(id) {
                if (!db) return showToast("Library is not available.");
                const request = db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).delete(id);
                request.onsuccess = () => {
                    showToast('Video deleted.');
                    loadLibrary();
                };
                request.onerror = () => showToast('Could not delete video.');
            }
            
            function openLibraryPlayer(blob) {
                libraryModalBlob = blob;
                libraryVideoPlayer.src = URL.createObjectURL(blob);
                libraryVideoPlayer.muted = false;
                libraryModal.classList.remove('hidden');
                libraryVideoPlayer.play().catch(e => console.error("Autoplay failed:", e));
            }
            
            function closeLibraryPlayer() {
                libraryVideoPlayer.pause();
                if (libraryVideoPlayer.src) URL.revokeObjectURL(libraryVideoPlayer.src);
                libraryVideoPlayer.src = '';
                libraryModal.classList.add('hidden');
                libraryModalBlob = null;
            }

            // --- Download & Share Flow ---
            function downloadAndSaveToLibrary() {
                if (!recordedBlob) return showToast("No video to download.");
                downloadVideo(recordedBlob);
                saveVideoToLibrary(recordedBlob);
                downloadModal.classList.remove('hidden');
            }
            
            function downloadVideo(blob) {
                if (!blob) return;
                const filename = generateFilename(blob.type);
                const videoURL = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = videoURL;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(videoURL);
                }, 100);
            }

            function generateFilename(mimeType) {
                const timestamp = new Date().toISOString().replace('T', '_').replace(/:/g, '-').split('.')[0];
                const extension = mimeType.includes('mp4') ? '.mp4' : '.webm';
                return `Shortie_${timestamp}${extension}`;
            }
            
            // --- Start the app ---
            init();
        });
    </script>

</body>
</html>
